<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>差分小工具</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        list-style: none;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      div {
        font-size: 22px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      span,
      select {
        font-size: 22px;
        margin: 1rem;
      }

      textarea {
        font-size: 22px;
      }

      .weightInput,
      .scoreInput {
        margin-bottom: 2rem;
      }

      .hidden {
        display: none;
      }

      button {
        margin: 1rem;
        font-size: 22px;
      }
    </style>
  </head>
  <body>
    <h1>我是差分檢查小工具</h1>
    <div>
      <span>請選擇評分制</span>
      <select name="method" id="method">
        <option value="1">百分制</option>
        <option value="2">配分制</option>
      </select>
    </div>
    <div class="weightInput hidden">
      <span>請輸入面向占比</span>
      <textarea
        class="clear"
        name="weight"
        id="weight"
        cols="30"
        rows="5"
        placeholder="可用空格、逗號或換行隔開數字
(請依序輸入占比)"
        autofocus
      ></textarea>
    </div>
    <div class="scoreInput">
      <span>請輸入分數</span>
      <textarea
        class="clear"
        name="score"
        id="score"
        cols="30"
        rows="5"
        placeholder="可用空格、逗號或換行隔開數字
(配分制請依照面向順序輸入)"
        autofocus
      ></textarea>
    </div>
    <div id="highLowResult"></div>
    <div id="stdResult"></div>
    <div id="avgResult"></div>
    <button>計算差分</button>

    <script>
      let excute = document.querySelector("button");
      let weightClass = document.querySelector(".weightInput");
      let method = document.querySelector("#method");
      // 評分制更換
      method.addEventListener("change", () => {
        if (method.value == 1) {
          weightClass.classList.add("hidden");
          document.querySelector("#highLowResult").innerHTML = "";
          document.querySelector("#stdResult").innerHTML = "";
          document.querySelector("#avgResult").innerHTML = "";
          document.querySelector("#weight").value = "";
          document.querySelector("#score").value = "";
        } else {
          weightClass.classList.remove("hidden");
          document.querySelector("#highLowResult").innerHTML = "";
          document.querySelector("#stdResult").innerHTML = "";
          document.querySelector("#avgResult").innerHTML = "";
          document.querySelector("#weight").value = "";
          document.querySelector("#score").value = "";
        }
      });

      excute.addEventListener("click", () => {
        let scores = document.querySelector("#score").value;
        let weight = document.querySelector("#weight").value;
        // 尾端去空格判斷
        if (scores[scores.length - 1] === " ") {
          scores = scores.substring(0, scores.length - 1);
        }
        if (weight[weight.length - 1] === " ") {
          weight = weight.substring(0, weight.length - 1);
        }
        let unsortScore = scores.split(/[,\s\n]+/).map(Number);
        scores = scores
          .split(/[,\s\n]+/)
          .map(Number)
          .sort();

        weight = weight.split(/[,\s\n]+/).map(Number);

        function minMax(array) {
          return array[array.length - 1] - array[0];
        }

        function std(array) {
          let Avg = array.reduce((x, y) => x + y) / array.length;
          let squaredDeviations = array.map((x) => (x - Avg) ** 2);
          let standardDeviation = Math.sqrt(
            squaredDeviations.reduce((x, y) => x + y) / squaredDeviations.length
          );
          return standardDeviation;
        }

        function compareWeight(arr1, arr2) {
          for (let i = 0; i < arr1.length; i++) {
            if (arr1[i] > arr2[i]) {
              return true;
            }
          }
        }
        function compareScore(arr) {
          for (let i = 0; i < arr.length; i++) {
            if (arr[i] > 100 || arr[i] < 0) {
              return true;
            }
          }
        }

        // 百分制
        if (method.value == 1) {
          if (compareScore(unsortScore)) {
            alert("分數需介於0~100之間");
          } else {
            // 高低差
            let gap = minMax(scores);
            document.querySelector("#highLowResult").innerHTML =
              "高低差為：" + Math.abs(gap.toFixed(2));
            // 標準差
            let stdResult = std(scores);
            document.querySelector("#stdResult").innerHTML =
              "標準差為：" + stdResult.toFixed(2);
            // 離均差
            let avgResult = document.querySelector("#avgResult");
            while (avgResult.firstChild) {
              avgResult.removeChild(avgResult.firstChild);
            }
            for (let i = 0; i < scores.length; i++) {
              let avg = scores.reduce((x, y) => x + y) / scores.length;
              let temp = unsortScore[i] - avg;
              let createD = document.createElement("div");
              createD.innerHTML =
                unsortScore[i] + " 的離均差為：" + Math.abs(temp.toFixed(2));
              avgResult.appendChild(createD);
            }
          }
        }
        // 配分制
        if (method.value == 2) {
          // 檢查分數
          let weightSum = weight.reduce((x, y) => x + y);
          if (weightSum !== 100) {
            alert("面向總和須為100");
          } else if (weight.length !== unsortScore.length) {
            alert("面向數量與分數數量需相同");
          } else if (
            compareWeight(unsortScore, weight) ||
            compareScore(unsortScore)
          ) {
            alert("面向分數需介於0-100且不得大於面向權重");
          } else {
            // 轉換百分制
            let percentScore = [];
            for (let i = 0; i < weight.length; i++) {
              let temp = (unsortScore[i] / weight[i]) * 100;
              percentScore.push(temp);
            }
            let percentScoreSort = percentScore.slice().sort();

            // 高低差
            let gap = minMax(percentScoreSort);
            document.querySelector("#highLowResult").innerHTML =
              "高低差為：" + Math.abs(gap.toFixed(2));

            // 標準差
            let stdResult = std(percentScoreSort);
            document.querySelector("#stdResult").innerHTML =
              "標準差為：" + stdResult.toFixed(2);

            // 離均差
            let avgResult = document.querySelector("#avgResult");
            let avg =
              percentScore.reduce((x, y) => x + y) / percentScore.length;

            while (avgResult.firstChild) {
              avgResult.removeChild(avgResult.firstChild);
            }

            for (let i = 0; i < percentScore.length; i++) {
              let temp = percentScore[i] - avg;
              let createD = document.createElement("div");
              createD.innerHTML =
                unsortScore[i] + " 的離均差為：" + Math.abs(temp.toFixed(2));
              avgResult.appendChild(createD);
            }
          }
        }
      });
    </script>
  </body>
</html>
